version: "3.9"

# ── Cloudreve + Telegram Adapter – Full Stack ────────────────────────────────
#
# Bring up the whole system:
#   docker compose up -d
#
# Prerequisites:
#   1. Copy .env.example to .env and fill in your values.
#   2. Ensure the "cloudreve-data" directory is writable.

services:

  # ── Cloudreve (user entry point) ──────────────────────────────────────────
  cloudreve:
    image: cloudreve/cloudreve:latest
    container_name: cloudreve
    restart: unless-stopped
    ports:
      - "5212:5212"
    volumes:
      - ./cloudreve-data/uploads:/cloudreve/uploads
      - ./cloudreve-data/db:/cloudreve/db
      - ./cloudreve-data/conf.ini:/cloudreve/conf.ini:ro
      - ./cloudreve-data/avatar:/cloudreve/avatar
    environment:
      - CLOUDREVE_CONF=/cloudreve/conf.ini
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:5212/api/v3/site/config"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ── K-Vault Telegram Adapter (middleware) ─────────────────────────────────
  adapter:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: kvault-adapter
    restart: unless-stopped
    depends_on:
      cloudreve:
        condition: service_healthy
    ports:
      - "3000:3000"
    volumes:
      - adapter-data:/app/data
    env_file:
      - .env
    environment:
      # Override Cloudreve URL to use the Docker service name
      CLOUDREVE_URL: http://cloudreve:5212

volumes:
  adapter-data:
